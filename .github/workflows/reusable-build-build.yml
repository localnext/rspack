name: Build Binding

on:
  workflow_call:
    inputs:
      target:
        required: true
        type: string
      runner:
        required: true
        type: string
      profile:
        default: 'ci'
        required: false
        type: string
      ref:
        required: false
        type: string
      prefer_docker:
        required: false
        default: true
        type: boolean

env:
  CARGO_INCREMENTAL: 0

jobs:
  build:
    name: Build
    runs-on: ${{ fromJSON(inputs.runner) }}
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.ref }}
          clean: ${{ runner.environment == 'github-hosted' }}

      - name: Pnpm Setup
        timeout-minutes: 5
        uses: ./.github/actions/pnpm/setup

      - name: Install Binding Dependencies
        uses: ./.github/actions/pnpm/install-binding-dependencies
        with:
          save-if: false

      - name: Install Rust Toolchain
        uses: ./.github/actions/rustup
        with:
          key: ${{ inputs.target }}-${{ inputs.profile }}
          save-if: true

      - name: Setup Rust Target
        run: rustup target add ${{ inputs.target }}

      # ---------- ANDROID SETUP ----------
      - name: Install Android NDK
        if: ${{ inputs.target == 'aarch64-linux-android' }}
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Configure Android toolchain
        if: ${{ inputs.target == 'aarch64-linux-android' }}
        run: |
          echo "[target.aarch64-linux-android]" >> .cargo/config.toml
          echo "linker = \"${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang\"" >> .cargo/config.toml

      # ---------- CODEGEN ----------
      - name: Run Cargo codegen
        run: cargo codegen

      - name: Trim paths
        run: |
          echo "" >> .cargo/config.toml
          echo "trim-paths = true" >> .cargo/config.toml

      # ---------- LINUX ----------
      - name: Build x86_64-unknown-linux-gnu
        if: ${{ inputs.target == 'x86_64-unknown-linux-gnu' && !inputs.prefer_docker }}
        run: |
          RUST_TARGET=${{ inputs.target }} pnpm build:binding:${{ inputs.profile }}

      - name: Build x86_64-unknown-linux-gnu (Docker)
        if: ${{ inputs.target == 'x86_64-unknown-linux-gnu' && inputs.prefer_docker }}
        uses: ./.github/actions/docker/linux-build
        with:
          image: ghcr.io/napi-rs/napi-rs/nodejs-rust:lts-debian
          target: ${{ inputs.target }}
          profile: ${{ inputs.profile }}

      - name: Build aarch64-unknown-linux-gnu (Docker)
        if: ${{ inputs.target == 'aarch64-unknown-linux-gnu' }}
        uses: ./.github/actions/docker/linux-build
        with:
          image: ghcr.io/napi-rs/napi-rs/nodejs-rust:lts-debian-aarch64
          target: ${{ inputs.target }}
          profile: ${{ inputs.profile }}
          pre: |
            export CC_aarch64_unknown_linux_gnu=clang

      # ---------- ANDROID BUILD ----------
      - name: Build aarch64-linux-android
        if: ${{ inputs.target == 'aarch64-linux-android' }}
        env:
          RUST_TARGET: aarch64-linux-android
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          DISABLE_PLUGIN: 1
        run: |
          pnpm build:binding:${{ inputs.profile }}

      - name: Normalize Android artifact name
        if: ${{ inputs.target == 'aarch64-linux-android' }}
        run: |
          mv crates/node_binding/*.node crates/node_binding/rspack.android-arm64.node

      # ---------- WINDOWS ----------
      - name: Build x86_64-pc-windows-msvc
        if: ${{ inputs.target == 'x86_64-pc-windows-msvc' }}
        run: RUST_TARGET=${{ inputs.target }} pnpm build:binding:${{ inputs.profile }}

      - name: Build aarch64-pc-windows-msvc
        if: ${{ inputs.target == 'aarch64-pc-windows-msvc' }}
        run: RUST_TARGET=${{ inputs.target }} DISABLE_PLUGIN=1 pnpm build:binding:${{ inputs.profile }}

      # ---------- MAC ----------
      - name: Build x86_64-apple-darwin
        if: ${{ inputs.target == 'x86_64-apple-darwin' }}
        run: RUST_TARGET=${{ inputs.target }} pnpm build:binding:${{ inputs.profile }}

      - name: Build aarch64-apple-darwin
        if: ${{ inputs.target == 'aarch64-apple-darwin' }}
        run: |
          export CC=$(xcrun -f clang)
          export CXX=$(xcrun -f clang++)
          SYSROOT=$(xcrun --sdk macosx --show-sdk-path)
          export CFLAGS="-isysroot $SYSROOT -isystem $SYSROOT"
          RUST_TARGET=${{ inputs.target }} pnpm build:binding:${{ inputs.profile }}

      # ---------- UPLOAD ----------
      - name: Upload artifact
        uses: ./.github/actions/artifact/upload
        with:
          name: bindings-${{ inputs.target }}
          path: |
            crates/node_binding/*.node
            crates/node_binding/*.d.ts
            crates/node_binding/*.wasm
